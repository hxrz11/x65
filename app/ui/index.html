<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>SGR Prompt Lab — Minimal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background:#f5f7fb; }
    header { padding: 12px 16px; background:#003366; color:#fff; }
    main { padding: 16px; display: grid; gap: 16px; }
    textarea, input, select { width: 100%; }
    textarea { min-height: 200px; font-family: ui-monospace, monospace; }
    .box { border: 1px solid #dde3ee; border-radius: 10px; padding: 12px; background:#fff; }
    .btn { padding: 8px 12px; border:1px solid #1d2a44; background:#f5f5f5; cursor:pointer; border-radius:8px;}
    .btn:active{transform:translateY(1px)}
    pre { background:#0f172a; color:#e5e7eb; padding:12px; border-radius:10px; overflow:auto; min-height:120px; }
    details summary { cursor:pointer; font-weight:bold; }
  </style>
</head>
<body>
  <header><strong>SGR Prompt Lab — Ленгазспецстрой</strong></header>
  <main>
    <section class="box" style="border-left:4px solid #00AEEF">
      <strong>Добро пожаловать!</strong>
      <div>Платформа для тестирования промптов бизнес‑логики компании Ленгазспецстрой.</div>
    </section>

    <section class="box">
      <h3>Модель и параметры</h3>
      <label>Модель</label>
      <select id="model_select"></select>
      <div>temperature <input id="temperature" value="0.2"></div>
      <div>top_p <input id="top_p" value="0.9"></div>
      <div>max_tokens <input id="max_tokens" value="1024"></div>
    </section>

    <section class="box">
      <h3>Промпты</h3>
      <label>System</label><textarea id="p_system"></textarea>
      <label>User</label><textarea id="p_user"></textarea>
      <label>Context</label><textarea id="p_ctx"></textarea>
    </section>

    <section class="box">
      <h3>Входные данные</h3>
      <label>Вопрос пользователя</label>
      <textarea id="question"></textarea>
      <label>Контекст JSON</label>
      <textarea id="context_json">{}</textarea>
      <button class="btn" onclick="runChat()">Запросить</button>
      <button class="btn" onclick="runChatStream()">Запросить (stream)</button>
    </section>

    <section class="box">
      <h3>Ответ</h3>
      <pre id="answer">(пока пусто)</pre>
      <details><summary>RAW</summary><pre id="raw"></pre></details>
    </section>
  </main>

<script>
async function api(path, method="GET", body=null){
  const res = await fetch(path, {method, headers:{"Content-Type":"application/json"}, body: body?JSON.stringify(body):null});
  if(!res.ok) throw new Error(await res.text());
  return await res.json();
}
async function loadModels(){
  const data = await api("/api/models/ollama_live");
  const sel = document.getElementById("model_select");
  sel.innerHTML="";
  (data.models||[]).forEach(m=>{ const o=document.createElement("option"); o.value=m; o.textContent=m; sel.appendChild(o); });
}
function getParams(){
  return {
    model_id: document.getElementById("model_select").value,
    params: {
      temperature: parseFloat(document.getElementById("temperature").value),
      top_p: parseFloat(document.getElementById("top_p").value),
      max_tokens: parseInt(document.getElementById("max_tokens").value)
    },
    messages: [
      {role:"system", content:document.getElementById("p_system").value},
      {role:"system", content:document.getElementById("p_ctx").value},
      {role:"user", content:document.getElementById("p_user").value.replaceAll("{question}",document.getElementById("question").value)}
    ]
  }
}
async function runChat(){
  const req = getParams();
  const out = await api("/api/chat","POST",req);
  document.getElementById("answer").textContent = out.content||"";
  document.getElementById("raw").textContent = JSON.stringify(out.raw||out,null,2);
}
async function runChatStream(){
  const req = getParams();
  const res = await fetch("/api/chat/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(req)});
  const reader = res.body.getReader(); const dec=new TextDecoder();
  document.getElementById("answer").textContent=""; let txt="";
  while(true){ const {done,value}=await reader.read(); if(done) break; const s=dec.decode(value); txt+=s; document.getElementById("answer").textContent=txt; }
}
window.addEventListener("load", loadModels);
</script>
</body>
</html>
